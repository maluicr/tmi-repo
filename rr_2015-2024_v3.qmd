---
title: "Mortalidade infantil em Portugal Continental 2015-2024"
subtitle: "Análise Bayesiana espaço-temporal com INLA"
short-title: "Evolução espaço-temporal"
author: 
  - name: Manuel Ribeiro
    affiliation: CERENA, Instituto Superior Técnico, Universidade de Lisboa
    orcid: 0000-0002-7890-7708
    url: https://cerena.ist.utl.pt/user/629
    email: manuel.ribeiro@tecnico.ulisboa.pt
  - name: Direção de Serviços de Informação e Análise
    affiliation: Direção Geral de Saúde
    url: https://www.dgs.pt/
abstract: |
  O objetivo desta análise é avaliar a evolução espacial e temporal da mortalidade infantil em Portugal Continental ao longo da última década (2015-2024). A partir de dados publicados pelo Instituto Nacional de Estatística referentes ao número anual de óbitos durante o primeiro ano de vida e número anual de nados-vivos por concelho, analisou-se o risco relativo de mortalidade infantil utilizando modelos hierárquicos Bayesianos com aproximação de Laplace (INLA). Os modelos incorporam efeitos espaciais estruturados e não-estruturados (BYM2), efeitos temporais (RW1), e uma covariável socioeconómica (Índice Europeu de Privação, EDI). Entre 2015-2021 observou-se um declínio generalizado na mortalidade infantil, que atingiu o valor mínimo nacional em 2021. No entanto, desde então a tendência inverteu-se, com aumentos significativos em alguns concelhos. Esta análise identifica concelhos com riscos relativos significativamente elevados (e.g., Barreiro, Amadora) e padrões de heterogeneidade espacial associados à privação socioeconómica.
date: |
  01/Dec/2025
code-repo: "Acesso ao código, dados e análise em <https://github.com/maluicr/>"
keywords:
  - mortalidade infantil
  - risco relativo
  - análise espaço-temporal
  - modelos Bayesianos
  - INLA
  - mapas de doenças
  - Portugal
crossref:
  sec-prefix: "Secção"
  eq-prefix: "Equação"
  fig-prefix: "Figura"
  tbl-prefix: "Tabela"
lang: pt  
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: right
    toc-title: "Conteúdos"
    page-layout: article
    number-sections: true
    number-depth: 4
    code-fold: true
    code-summary: "Mostrar código"
    code-tools: true
    code-link: true
    theme: 
      light: flatly
      dark: darkly
    fig-width: 8
    fig-height: 6
    fig-dpi: 300
    embed-resources: true
    smooth-scroll: true
    link-external-newwindow: true
execute:
  echo: false
  warning: false
  message: false
  cache: true
  freeze: auto
knitr:
  opts_chunk:
    fig.align: 'center'
    out.width: '100%'
editor: visual
---

```{=html}
<style type="text/css">
   .main-container { max-width: 80%; margin: auto}
   .row {display: flex;}
   .column {flex: 50%;}
</style>
```


```{r setup, include=FALSE}
if (is.null(knitr::pandoc_to())) {
  fmt_out <- "interactive"
} else {
  fmt_out <- knitr::pandoc_to()
}

knitr::opts_chunk$set(echo = FALSE, include = TRUE, 
                      warning = FALSE, message = FALSE)

knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,
                      fig.width = 6, fig.height = (6 * 0.618),
                      out.width = "100%", collapse = F)

options(digits = 3, width = 120,
        dplyr.summarise.inform = FALSE,
        knitr.kable.NA = "")
```

## Dados {#sec-Dados}

Para analisar a evolução espaço-temporal da mortaliade infantil em Portugal desde 1 de janeiro de 2015 a 31 de dezembro de 2024, foram usados os dados seguintes, fornecidos pelo Instituto Nacional de Estatística :

- Óbitos de menos de 1 ano (N.º) por concelho, por ano;
- Nados-vivos (N.º) por concelho de residência da mãe.

Para além destes dados foram também usados os dados do European Deprivation Index 2011 - EDI. O EDI é um índice ajustado para Portugal^[https://doi.org/10.1371/journal.pone.0208320] que serve de indicador sobre o grau de privação socio-económica em cada concelho. Valores mais altos deste índice estão associados a concelhos com maior grau de privação socio-económica. Os dados do índice serviram para explorar diferenças na mortalidade infantil por concelho e ano, controlando o efeito do grau de privação.

```{r livrarias}
library(sf) # spatial data
library(dplyr) # pipelines  
library(reshape2) # melt long wide tables
library(ggplot2) # nice plots
library(leaflet) #  mapview
library(SpatialEpi) # clustering with satscan
library(cowplot) # 2+ ggplots 
library(INLA) # R-INLA
library(ggrepel) # arranja texto ggplot
source("f_tabelas.R")
```


```{r dados-gis}
# shapefile pt cc
pt_gis <- st_read("../gis/cc_caop2013_pop19.shp", quiet = TRUE)[,c("oid_","nome_cc")]
pt_gis <- pt_gis[order(pt_gis$nome_cc), ]
pk <- pt_gis$nome_cc
```


```{r dados-tmi}

casos <- read.table("./docs/casos.txt", sep = "\t", header = T, encoding = "latin1")
# retirar acores e madeira
casos <- casos %>% filter(Nomes_cc %in% pk)
names(casos) <- c("cc", 2015:2024)

pop <- read.table("./docs/pop.txt", sep = "\t", header = T, encoding = "latin1")
# retirar acores e madeira
pop <- pop %>% filter(Nomes_cc %in% pk)
names(pop) <- c("cc", 2015:2024)

casos_melt <- casos %>% melt(., id.vars = "cc")
pop_melt <- pop %>% melt(., id.vars = "cc")

data <- as.data.frame(cbind(casos_melt, pop = pop_melt$value))
names(data) <- c("cc", "ano", "y", "pop")
```

```{r dados-edi}
edi <- read.table("./docs/edi_2011.csv", sep = ";", dec = ",", header = T, encoding = "latin1")
edi$EDI_QUINTILE <- factor(edi$EDI_QUINTILE)
data <- dplyr::inner_join(data, edi[,c("GEO_COD_DSG","EDI_SCORE","EDI_QUINTILE")], by = c("cc" = "GEO_COD_DSG"))
```

A informação geográfica com o mapa de Portugal usado para realizar a análise espacial por concelho é fornecido em formato digital (*shapefile*) pela Direção Geral de Saúde^[https://www.dgterritorio.gov.pt/cartografia/cartografia-tematica/caop]. 

```{r dados-sir}

# SMR = O/E
E <- expected(
  population = data$pop,
  cases = data$y,
  n.strata = 1
)

data$E <- E
data$sir <- data$y/data$E
data$tmi <- round(1000 * data$y / data$pop,2)
d <- data[order(data$ano, data$cc), ]
d$ano <- as.numeric(as.character(d$ano))

# mapa reshape para plot shape
dw <- reshape(d,
              timevar = "ano",
              idvar = "cc",
              direction = "wide"
)

# mapa
mapa <- dplyr::left_join(pt_gis, dw, by = c("nome_cc" = "cc"))
mapa <- mapa %>%
  pivot_longer(
    cols = c(paste0("sir.", 2015:2024), 
             paste0("tmi.", 2015:2024), 
             paste0("EDI_SCORE.", 2015:2024),
             paste0("EDI_QUINTILE.", 2015:2024),
             paste0("y.", 2015:2024),
             paste0("pop.", 2015:2024),
             paste0("E.", 2015:2024)
             ),
    names_to = c(".value", "ano"),
    names_pattern = "(sir|tmi|EDI_SCORE|EDI_QUINTILE|y|pop|E)\\.(.*)"
  )
mapa$ano <- as.integer(mapa$ano)
```


## Métodos {#sec-Metodos}

### Risco relativo {#sec-MetodosRR}

As estimativas das taxas de mortalidade infantil por concelho podem ser extremamente variáveis devido ao efeito de escala (em concelhos com populações de dimensão reduzida as taxas tendem a ser mais instáveis e a incerteza associada tende a ser maior). Por isso, neste estudo, estima-se o risco relativo (RR) de mortalidade infantil por concelho em vez da taxa de mortalidade, porque esta é invariante à escala. Esta abordagem permite atenuar o efeito das populações de dimensão reduzida nas estimativas do RR, através de modelos de regressão aditivos que incorporam efeitos espaciais e temporais estruturados, e partilham informação entre concelhos vizinhos.

Em alguns dos modelos a especificar será adicionada a covariável EDI, para avaliar o impacto dos efeitos espaciais e temporais na variação do RR controlando o efeito do grau de privação socio-económica.

### Regressão Bayesiana {#sec-MetodosModelosBayes}

A modelação espaço-temporal é baseada na regressão Bayesiana. A inferência dos parâmetros e dos hiperparâmetros é realizada de acordo com a aproximação INLA (Integrated Nested Laplace Approximation^[https://doi.org/10.1016/j.csda.2013.04.014]). Esta estratégia assenta numa simplificação (os modelos podem ser expressos como processos estocásticos gaussianos latentes de Markov ) que permite explorar a estrutura esparsa da matriz de precisão, possibilitando aproximações determinísticas rápidas e precisas das distribuições marginais posteriores.

O modelo inclui efeitos fixos para a ordenada na origem e para o EDI como covariável explicativa. Os efeitos aleatórios incorporam três componentes: uma componente espacial modelada através do modelo BYM2 (Besag-York-Mollié) que combina variação espacialmente estruturada, capturando a dependência entre concelhos adjacentes, e variação não estruturada; uma componente temporal representada por um passeio aleatório de primeira ordem, que captura a evolução temporal ao longo do período analisado; e uma componente de interação espaço-temporal. 

Os hiperparâmetros de precisão foram modelados com distribuições à priori de penalização de complexidade (PC priors), favorecendo modelos menos complexos (mais simples) e permitindo incorporar conhecimento prévio sobre a importância esperada da variabilidade espacial e temporal.

#### Modelo

O modelo usado neste estudo é um modelo aditivo generalizado com distribuição de Poisson e função de ligação canónica (log):

$$
Y_{ij}\sim \text{P}\big(E_{ij}\theta_{ij}\big)
$$

onde $Y_{ij}$ representa o número de óbitos com menos de um ano de vida observados no concelho $i$ no ano $j$, $E_{ij}$ representa o número de óbitos esperados no concelho $i$ no ano $j$ (offset) se a taxa de mortalidade infantil fosse a da população de referência e $\theta_{ij}$ representa o RR de morrer durante o primeiro ano de vida no concelho $i$ no ano $j$.

Exploraram-se diferentes especificações para modelar $\log(\theta_{ij})$ (em vez de $\theta_{ij}$ usa-se a função de ligação canónica $\log(\theta_{ij})$ da distribuição de Poisson, por causa da relação linear com os preditores, no contexto dos modelos aditivos generalizados): 

\begin{align}
M1: \log(\theta_{ij})&=\alpha+\beta t_j \\
M2: \log(\theta_{ij})&=\alpha+u_i+v_i+(\beta+\delta_i)* t_j \\
M3: \log(\theta_{ij})&=\alpha+u_i+v_i+\gamma_j + \phi_j \\
M4: \log(\theta_{ij})&=\alpha+u_i+v_i+\gamma_j + \phi_j + \delta_{ij}\\
M5: \log(\theta_{ij})&=\alpha+u_i+v_i+(\beta+\delta_i)* t_j + \beta_{\scriptsize\text{EDI}} \times \scriptsize\text{EDI}_i \\
M6: \log(\theta_{ij})&=\alpha+u_i+v_i+\gamma_j + \phi_j + \beta_{\scriptsize\text{EDI}} \times \scriptsize\text{EDI}_i \\
M7: \log(\theta_{ij})&=\alpha+u_i+v_i+\gamma_j + \phi_j + \delta_{ij} + \beta_{\scriptsize\text{EDI}} \times \scriptsize\text{EDI}_i 
\end{align}

Onde: 

- $\alpha$ representa a ordenada na origem; 
- $\beta$ representa a tendência linear temporal (impacto global, i.e., independente do concelho);
- $t_j$ representa o índice temporal correspondente ao ano $j$;
- $u_i$ representa a componente espacial estruturada;
- $v_i$ representa a componente espacial não-estruturada, i.i.d com distribuição $\text{N}\sim (0,\sigma_v^2)$; 
- $\delta_i$ representa o impacto linear do tempo em cada concelho (impacto local); 
- $\gamma_j$ representa a componente temporal estruturada no tempo (i.e. autocorrelacionada);
- $\phi_j$ representa a componente temporal não-estruturada, com distribuição $\text{N}\sim (0,\sigma_\phi^2)$;
- $\delta_{ij}$ representa um termo de interação dos efeitos espaciais e temporais não-estruturados;
- $\beta_{\scriptsize\text{EDI}}$ representa o efeito associado à covariavel indice EDI.

```{r madj-inla}

library(INLA)
library(spdep)


# cria lista poligonos vizinhos
# portugal (apenas 278 obs)
# apenas para vizualizar matriz de vizinhos
# NAO USADA NOS CALCS!!
# nb_pt <- poly2nb(pt_gis)
# nb2INLA("map_pt.adj", nb_pt)
# g_pt <- inla.read.graph(filename = "map_pt.adj")
# image(inla.graph2matrix(g_pt),xlab="",ylab="")

# cria lista poligonos vizinhos
# portugal (2780 obs, 278 cc * 10 anos)
# nb <- poly2nb(mapa)
# saveRDS(nb,"matviz.rds")
nb <- readRDS("matviz.rds")
# head(nb)

# converte lista para INLA
nb2INLA("map.adj", nb)

g <- inla.read.graph(filename = "map.adj")
# image(inla.graph2matrix(g),xlab="",ylab="")

# efeito aleatorio espacial
# indices das areas, anos e interacoes

d$idtime <- 1 + d$ano - min(d$ano)
d$idtime1 <- d$idtime
d$idtimeint <- d$idtime

d$idarea <- as.numeric(as.factor(d$cc))
d$idarea1 <- d$idarea
d$idareaint <- d$idarea

d$idareatime <- seq(1,length(d$idarea))
d$idtimearea <- d$idareatime
```

Os termos $u_i$, $v_i$, $\gamma_i$ e $\phi_i$ são funções (especificadas por priors, conforme se apresenta na secção seguinte) que estimam os efeitos estruturados e não-estruturados (ou aleatórios) das componentes espacial e temporal. 

O ajustamento destes modelos com nível de complexidade crescente mostrou-se útil para a exploração dos dados. Partindo de um modelo temporal de tendência linear global (M1) adicionaram-se as componentes espacial e temporal com efeitos estruturados e não-estruturados (M2-M3), a interação entre ambos (M4) e ainda o impacto destas componentes controlando o efeito do indice de privação socio-económico (EDI) (M5-M7).

Toda a análise estatística foi realizada em linguagem R^[R Core Team (2024). R: A Language and Environment for Statistical Computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/] com o package INLA^[https://doi.org/10.1111/j.1467-9868.2008.00700.x].

#### Priors{#sec-MetodosPriors}

Para a especificação das *priors* tomou-se em consideração a redução acentuada e consistente na mortalidade infantil observada desde a decada de 1970 (dados Pordata^[https://www.pordata.pt/pt/estatisticas/populacao/esperanca-de-vida-e-obitos/taxa-de-mortalidade-infantil-0]). O aumento da taxa a partir de 2021 leva a considerar uma variação temporal e espacial do risco relativo com variabilidade moderada.

```{r priors-inla}

# funcoes para as prior

# efeito aleatorio espacial juntos ui+vi
hyper.bym2 <- list(
  prec = list(prior = "pc.prec", param = c(0.5, 0.8)),   # precisão conservadora
                                                          # p(sd>0.5)=0.8
  phi = list(prior = "pc", param = c(0.5, 0.1))           # estrutura espacial "moderada"
                                                          # p(autoc/random>0.5)=0.1 (autocorr/rand ~ [0,1])
)

# <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
# alternativa com efeito aleatorio espacial
# estruturado (ui) e não estruturado (vi) separados
# hiperpriors apenas para a precisão 
# <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

# hyper.besag <- list(  # Structured spatial (bi)
#   prec = list(
#     prior = "pc.prec",
#     param = c(1, 0.01)
#   )
# )
# 
# hyper.iid <- list(  # Unstructured spatial (hi)
#   prec = list(
#     prior = "pc.prec",
#     param = c(1, 0.01)
#   )
# )

# estrutura temporal (de declínio suave)
hyper.temporal <- list(
  prec = list(prior = "pc.prec", param = c(0.5, 0.15))  # variacao temporal suave, baixo sd ao longo do tempo,
                                                        # p(sd>0.5)=0.1
)

# interação espaço-temporal (baixa expressao, "outliers alisados" )
hyper.st <- list(
  prec = list(prior = "pc.prec",  param = c(1.5, 0.1))    # termo de interacao reduzido p(sd>1)=0.1
                                                        # interação sem expressao.
)

# covariaveis (edi informativa)
control.fixed <- list(
  mean.intercept = 0,       # pouco informativa para a ordenada na origem
  prec.intercept = 0.01,   
  mean = 0.15,               # trend edi  
  prec = .7                  # quanto maior o valor edi -> mais privação -> mais mortalidade ~ exp(.1) = 10,5%)
)
```


```{r modelos-inla}

# adaptado de 
# Cap 7, Spatial and Spatio-temporal Bayesian Models with R-INLA
# Marta Blangiardo, Michella Cameleti

# m1 - componente temporal (c ef fixo, linear)
m1 <- y ~ 1 + idtime
m1_res <- inla(m1, family = "poisson",
               data = d, E = E,
               control.fixed = control.fixed,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))

m2 <- y ~ 1 + idtime + 
  f(idarea, model = "bym2", graph = g, hyper = hyper.bym2, constr = T) +  # Structured spatial (bi)
  f(idarea1, idtime, model = "iid", hyper = hyper.st, constr = T) # interacao iid
m2_res <- inla(m2,
               family = "poisson",
               data = d,
               E = E,
               control.fixed = control.fixed,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))

# m3
m3 <- y ~ 1 + f(idarea,model="bym2",graph=g, hyper = hyper.bym2) +
  f(idtime, model= "rw1", hyper = hyper.temporal) + 
  f(idtime1, model = "iid" )
lcs <- inla.make.lincombs(idtime = diag(10), idtime1 = diag(10))
m3_res <- inla(m3,
               family="poisson",
               data=d,
               E=E,
               control.predictor=list(compute=TRUE),
               lincomb=lcs,
               control.compute = list(dic = TRUE, waic = TRUE))

m4 <- y ~ 1 + f(idarea, model = "bym2", hyper = hyper.bym2 , graph=g) +
  f(idtime, model = "rw1", hyper = hyper.temporal) +
  f(idtime1, model = "iid") +
  f(idareatime, model = "iid", hyper = hyper.st)
m4_res <- inla(m4,
               family = "poisson",
               data = d,
               E = E,
               control.fixed = control.fixed,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))


m5 <- y ~ 1 + idtime + EDI_SCORE +
  f(idarea, model = "bym2", graph = g, hyper = hyper.bym2) +  # Structured spatial (bi)
  f(idarea1, idtime, model = "iid", hyper = hyper.st) # interacao iid
m5_res <- inla(m5,
               family = "poisson",
               data = d,
               E = E,
               control.fixed = control.fixed,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))

# m3
m6 <- y ~ 1 + EDI_SCORE + 
  f(idarea,model="bym2",graph=g, hyper = hyper.bym2) +
  f(idtime, model= "rw1", hyper = hyper.temporal) + 
  f(idtime1, model = "iid" )
lcs <- inla.make.lincombs(idtime = diag(10), idtime1 = diag(10))
m6_res <- inla(m6,
               family="poisson",
               data=d,
               E=E,
               control.predictor=list(compute=TRUE),
               lincomb=lcs,
               control.compute = list(dic = TRUE, waic = TRUE))

m7 <- y ~ 1 + EDI_SCORE +
  f(idarea, model = "bym2", hyper = hyper.bym2 , graph=g) +
  f(idtime, model = "rw1", hyper = hyper.temporal) +
  f(idtime1, model = "iid") +
  f(idareatime, model = "iid", hyper = hyper.st)
m7_res <- inla(m7,
               family = "poisson",
               data = d,
               E = E,
               control.fixed = control.fixed,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))

mall_name <- c(paste0("M", 1:7))

# dic
dicval <- rbind(m1_res$dic$dic,
m2_res$dic$dic,
m3_res$dic$dic,
m4_res$dic$dic,
m5_res$dic$dic,
m6_res$dic$dic,
m7_res$dic$dic)

# waic
waicval <- rbind(m1_res$waic$waic,
m2_res$waic$waic,
m3_res$waic$waic,
m4_res$waic$waic,
m5_res$waic$waic,
m6_res$waic$waic,
m7_res$waic$waic)

mall_res <- data.frame(Modelo = mall_name, DIC = dicval, WAIC = waicval)

```

Foi implementada uma análise de sensibilidade com diferentes especificações das distribuições à priori (baseadas na literatura). Os resultados apresentados (M1 a M7) correspondem à configuração que demonstrou melhor e mais consistente ajuste aos dados (DIC).

##### Efeitos fixos {#sec-MetodosFixos}

Para a tendência global especificou-se uma distribuição gaussiana não-informativa de média nula e precisão $\tau= 1/\sigma^2=$ `r control.fixed$prec.intercept`.
$$
\alpha \sim N(`r control.fixed$mean.intercept`, `r 1/control.fixed$prec.intercept`)
$$

Para o parâmetro associado ao índice EDI especificou-se uma prior informativa com distribuição gaussiana: 

$$
\beta_{EDI} \sim N(`r sprintf("%.2f", control.fixed$mean)`, `r sprintf("%.2f", 1/control.fixed$prec)`)
$$

assumindo à priori a expectativa de uma associação positiva entre a privação socio-económica e a mortalidade infantil (espera-se que quanto maior for o valor do índice, maior será o RR).

##### Efeitos aleatórios {#sec-MetodosAleatorios}

As distribuições a priori para os hiperparâmetros dos efeitos aleatórios foram especificadas usando priors de complexidade penalizada^[https://doi.org/10.1214/16-STS576] (PC priors). 

Para a componente espacial ($u_i+v_i$) adoptou-se o modelo BYM2 (Besag-York-Mollié) especificado com uma combinação de *priors* com componente estruturada, $u_i$, e componente não-estruturada,  $v_i$, onde $u_i$ segue um modelo condicional autoregressivo intrinseco (iCAR) e $v_i$ segue uma distribuição gaussiana de média nula e variancia unitária. Este modelo parametriza esta soma em termos de uma precisão marginal e um parâmetro de mistura que controla a proporção da variância atribuída à componente estruturada. Para o desvio padrão marginal (inversa da precisão) desta compontente, $\sigma_{u+v}$, especificou-se uma PC prior com probabilidade `r hyper.bym2$prec$param[2]*100`% do desvio-padrão ser maior que `r hyper.bym2$prec$param[1]`:

$$
P(\sigma_{u+v}>`r hyper.bym2$prec$param[1]`)= `r hyper.bym2$prec$param[2]`
$$

Esta especificação favorece uma baixa variabilidade espacial no contexto do RR.

Para o parâmetro de mistura do modelo BYM2, $\rho$ especificou-se uma PC prior que reflete a convição à priori de que a componente de dependência espacial (estruturada) é moderadamente mais relevante que a heterogeneidade não estruturada na explicação da variabilidade do RR entre concelhos. Especificamente, atribuiu-se `r hyper.bym2$phi$param[2]*100`% de probabilidade a priori de que a proporção da variância espacial explicada pela componente estruturada ser `r hyper.bym2$phi$param[1]`.

$$
P(\rho> `r hyper.bym2$phi$param[1]`)=`r hyper.bym2$phi$param[2]`
$$

Para a estrutura temporal especificou-se um passeio aleatório de primeira ordem (RW1) com erros aleatórios, $\epsilon$, gaussianos com média nula e variância unitária:

$$
\gamma_j = \gamma_{j-1}+ \epsilon_j
$$

Para o desvio padrão marginal das diferenças temporais, especificou-se uma PC prior que favorece uma evolução temporal suave, com apenas `r hyper.temporal$prec$param[2]*100`% de probabilidade *a priori* de o desvio padrão das inovações exceder `r hyper.temporal$prec$param[1]`:

$$
P(\sigma_{\gamma}>`r hyper.temporal$prec$param[1]`)=`r hyper.temporal$prec$param[2]`
$$



## Resultados {#sec-Resultados}

### Mortalidade infantil {#sec-ResultadosTMI}

A taxa de mortalidade infantil (TMI) anual observada foi a seguinte:

```{r tmistats}
smrstats <- data %>%
  group_by(ano) %>%
  summarise(
    TMI = mean(tmi, na.rm = TRUE),
    # mediana = median(sir, na.rm = TRUE),
    # min = min(sir, na.rm = TRUE),
    # max = max(sir, na.rm = TRUE),
    # stdev = sd(sir, na.rm = TRUE),
    # cv = round(sd(sir, na.rm = TRUE)/mean(sir, na.rm = TRUE),1),
    .groups = 'drop'
  ) %>%
  st_drop_geometry()

names(smrstats) <- c("Ano","TMI")
smrstats$Ano <- factor(smrstats$Ano)

# tmi nacional/ano tabela

  as.data.frame(smrstats) %>%
    mutate(across(where(is.numeric), ~format(round(.x, 2), nsmall = 2))) %>%
    t() %>%
    kable(format = "html", escape = FALSE) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  full_width = F,
                  font_size = 12)
```

Em termos globais, e até ao ano de 2021, a evolução da taxa anual de mortalidade infantil evidenciou uma tendência de decréscimo. No entanto, a partir desse ano a tendência inverteu-se e, desde então, as taxas anuais de mortalidade infantil têm vindo a aumentar. 

```{r tmistats-plot, out.width="50%", fig.align='center'}

# tmi nacional/ano grafico
ggplot(smrstats, aes(x = Ano, y = TMI)) +
  geom_line(aes(group = 1), colour = "darkgrey", size = 1) +
  geom_point(size = 4, colour = "darkred") +
  theme(legend.position = "none")

```

```{r tmi-raw}
df_tmi <- data %>%
  dplyr::select(cc, ano, tmi) %>%
  pivot_wider(names_from = ano, values_from = tmi)
```

No gráfico seguinte apresentam-se as séries temporais, por concelho. Ilustram-se algumas séries temporais com cores, para evidenciar que TMI anuais muito elevadas (e.g. superiores a 10 por 1000 nados-vivos) tendem a ocorrer em concelhos pouco povoados, com baixo número de nascimentos (e.g Mora, Fornos de Algodres), enquanto que em concelhos com muitos nascimentos (e.g. Lisboa ou Porto), as TMI são mais baixas e mais estáveis.  

```{r smr-time-plot, out.width="50%", fig.align='center', message=F, warning=F}
# time series
gt <- ggplot(d, aes(x = ano, y = tmi, group = cc, color = cc)) +
  geom_line() +
  geom_point(size = 2) +
  scale_x_continuous(breaks = 2015:2024) +
  labs(y = "TMI", x = "Ano") +
  theme(legend.position = "none")

# higlight
library(gghighlight)
gh <- gt + gghighlight(cc %in% c("Lisboa","Mora", "Fornos de Algodres", "Cuba", 
                                 "Castanheira de Pêra", "Porto"))
gh
# ggsave("ts-cc.png")
```

Na tabela seguinte apresentam-se as TMI anuais médias, estratificadas pelo índice de privação (EDI) que se apresenta agrupado da seguinte forma:

- Grupo 1, concelhos com valor EDI no 1º quintil (0-20) (menor privação), 
- Grupo 2, concelhos com valor EDI no 2º quintil (20-40), 
- Grupo 3, concelhos com valor EDI no 3º quintil (40-60),
- Grupo 4, concelhos com valor EDI no 4º quintil (60-80),
- Grupo 5, concelhos com valor EDI no 5º quintil (80-100) (maior privação). 

Na tabela seguinte mostram-se as TMI médias obtidas em cada grupo e ano.

```{r ediq-tabela, fig.align='center'}

data %>%
  group_by(EDI_QUINTILE, ano) %>%
  summarise(TMI = mean(tmi, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = ano, values_from = TMI) %>%
  mutate(across(where(is.numeric) & !EDI_QUINTILE, ~sprintf("%.2f", .x))) %>%
  kable(format = "html", escape = FALSE,
        col.names = c("EDI (Quintil)", 2015:2024)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE,
                font_size = 12)
```

Na figura seguinte apresentam-se os valores do índice EDI nos concelhos projectados no mapa de Portugal, por quintil. Observa-se uma tendência para maior concentração de índices de privação socio-económica mais baixos (concelhos no quintil 1) na região norte e de índices de privação mais elevados (concelhos no quintil 5) na região sul.

```{r ediq-mapa, out.width="80%", fig.align='center'}
# mapa EDI

map_data <- dplyr::inner_join(pt_gis, edi[,c("GEO_COD_DSG","EDI_SCORE","EDI_QUINTILE")], by = c("nome_cc" = "GEO_COD_DSG"))

# ggplot(data) + geom_sf(aes(fill = EDI_SCORE)) +
#   facet_wrap(~EDI_QUINTILE, dir = "h", ncol = 5) +
#   ggtitle("RR (M6)") + theme_bw() +
#   theme(
#     axis.text.x = element_blank(),
#     axis.text.y = element_blank(),
#     axis.ticks = element_blank()
#   ) +
#   scale_fill_gradient2(
#     midpoint = 1, low = "blue", mid = "white", high = "red"
#   )
# ggsave("rr6.png")
#
# Criar dados sem a variável de facet para o contorno
data_contorno <- map_data %>% select(-EDI_QUINTILE)

ggplot() +
  geom_sf(data = data_contorno, fill = NA, color = "grey80", linewidth = 0.1) +
  geom_sf(data = map_data, aes(fill = EDI_SCORE), color = "grey80", linewidth = 0.1) +
  facet_wrap(~EDI_QUINTILE, dir = "h", ncol = 5) +
  ggtitle("Distribuição espacial do indice EDI por quintil") +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  ) +
  scale_fill_viridis_c(option = "magma", direction = -1, name = "Indice EDI")
```


Com base nos dados observados de mortalidade infantil apresentados, procedeu-se à modelação Bayesiana espacial e temporal para  estimar os RRs de mortalidade infantil nos concelhos de Portugal Continental. A análise de diferentes especificações de modelos (M1-M7) írá contribuir para avaliar o impacto da componente espacial, temporal e da privação socioeconómica (indice EDI) na variabilidade observada nas TMI.

### Risco relativo {#sec-ResultadosRR}

Para os modelos ajustados (M1-M7) com priors especificadas na @sec-MetodosPriors apresentam-se na tabela seguinte os resultados obtidos com as medidas de ajustamento Deviance Information Criterion (DIC) e Watanabe-Akaike Information Criterion (WAIC).

```{r tab-modelos}

mall_res %>%
  mutate(DIC = sprintf("%.2f", DIC),
         WAIC = sprintf("%.2f", WAIC)) %>%
  kable(format = "html", escape = FALSE,
        col.names = c("Modelo", "DIC", "WAIC")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE,
                font_size = 12)
```

A partir da tabela observa-se que os modelos M2-M7 apresentam melhores ajustamentos que M1 - o único modelo que inclui apenas efeitos globais. Observa-se também que, com a integração da covariável EDI (M5-M7), a qualidade do ajustamento melhora em relação a (M2-M4). O melhor desempenho observa-se nos modelos M6 e M7 mas sugere que a inclusão de um termo de interação com a componente espacial (M7) não traz melhorias relevantes em relação ao modelo sem interação (M6).

Para facilitar a interpretação dos resultados, opta-se por apresentar no resto desta secção apenas os modelos M1, M2 e M6. Estes três modelos ilustram a evolução da complexidade: M1 como modelo base (evolução global), M2 com componentes espacial e temporal (global e local), e M6 com as componentes espacial, temporal e a covariável de privação socioeconómica.

#### Modelo M1 {#sec-ResultadosM1}

O modelo M1 especifica um efeito temporal global, $\beta$, como preditor linear do (log) risco relativo, $\log(\theta_{ij})$, da mortalidade no concelho $i$ e ano $j$:

$$\log(\theta_{ij})=\alpha+\beta t_j$$

onde,

- $\alpha$ representa a ordenada na origem; 
- $\beta$ representa a tendência linear temporal (impacto global, i.e., independente do concelho);
- $t_j$ representa o índice temporal correspondente ao ano $j$;

```{r tab-m1}
m1_sum <- round(m1_res$summary.fixed[,1:5],3)
rownames(m1_sum) <- c("\u03b1", "\u03b2")
m1_beta <- exp(round(m1_res$summary.fixed[2,1],2))
```

Embora o resultado dos últimos anos (2021-2024) aponte para um aumento da taxa de mortalidade infantil, o resultado do modelo M1 sugere que se mantém a tendência global de redução significativa do risco relativo ao longo periodo analisado de `r round(100*(1- m1_beta))`\% ($\exp(\beta) \approx `r m1_beta`$). O intervalo de credibilidade de 95% da distribuição à posteriori dos parâmetros obtidos para M1 apresentam-se na tabela seguinte:

```{r m1-tabela}

m1_sum %>%
  kable(format = "html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE,
                font_size = 12)
```

No gráfico seguinte ilustra-se o efeito global do tempo na variação do risco relativo da mortalidade infantil, representada pela média da distribuição à posteriori de $\beta$, e respetivos limites inferior e superior (linhas tracejadas) para um intervalo de credibilidade de 95%.

```{r m1-betaplot, out.width="50%", fig.align='center'}

m1_betaplot <- m1_res$summary.fixed[2,1:5]
beta_mean <- m1_betaplot["idtime", "mean"]
beta_lower <- m1_betaplot["idtime", "0.025quant"]
beta_upper <- m1_betaplot["idtime", "0.975quant"]

t <- seq(1, 10, length.out = 10)
fit <- beta_mean * t
lfit <- beta_lower * t
ufit <-beta_upper * t
# plot(t,fit, type = "l", lty =1 )
# lines(lfit, lty = 2)
# lines(ufit, lty = 2)

# df plot
plot_data <- data.frame(
  tempo = t,
  beta = fit,
  beta_low = lfit,
  beta_upp = ufit
)

# plot
ggplot(plot_data, aes(x = tempo)) +
  geom_line(aes(y = beta), linetype = 1, size = .5, color = "black") +
  geom_line(aes(y = beta_low), linetype = 2, size = 0.5, color = "black") +
  geom_line(aes(y = beta_upp), linetype = 2, size = 0.5, color = "black") +
  scale_x_continuous(breaks = seq(2,10,2)) +
  labs(
    x = "t",
    y = "Beta * t"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  )

```

Será consensual considerar que um dos problemas de M1 é o de ser linear e não conseguir captar a tendência de aumento acentuado observado nos últimos anos. Nas secções seguintes serão analisados os modelo M2 e M6, onde se adicionam a componente espacial e temporal (com os efeitos global e local) para avaliar o impacto na variação da mortalidade infantil observada.

#### Modelo M2 {#sec-ResultadosM2}

No modelo M2 ajustou-se um efeito aleatório das componentes espacial - $u_i + v_i$ - e temporal - $\beta + \delta_i$ -, onde $u_i$ e $v_i$ representam a componente espacial estruturada e não-estruturada, $\beta$ representa a tendência global e linear ao longo do tempo e $\delta_i$ representa a interação entre o tempo e o espaço (i.e. o concelho $i$), ou seja,  a diferença entre a tendência temporal global ($\beta$) e a tendência temporal específica de cada concelho. 

$$
\log(\theta_{ij})=\alpha+u_i+v_i+(\beta+\delta_i)* t_j 
$$

```{r m2-mapvars}

m2_mar_zeta <- m2_res$marginals.random[[1]][1:2780] # 278*10 anos
m2_mar_delta <- m2_res$marginals.random[[2]][1:278]
zeta <- unlist(lapply(m2_mar_zeta,function(x)inla.emarginal(exp,x)), use.names = F)
delta <- unlist(lapply(m2_mar_delta,function(x)inla.emarginal(exp,x)), use.names = F)
```

O mapa seguinte ilustra as estimativas obtidas para $\exp(\delta_i)$ com o modelo M2, em cada concelho e referem-se à média da distribuição à posteriori de $\exp(\delta_i)$ obtida em cada concelho. A função exponencial aplicada a $\delta_i$ representa o efeito (multiplicativo) do concelho $i$ em relação à tendência temporal média de mortalidade infantil esperada para o país.

```{r m2-mapa-delta-pt-leaf, fig.align='center', out.width="50%"}


# mapa leaflet
d_gis <- pt_gis
d_gis$delta <- delta
d_giswgs <- st_transform(d_gis, 4326)

delta_i <- m2_res$summary.random$idarea1
df_deltai <- data.frame(
  idarea = delta_i$ID,
  linf95 = exp(delta_i$`0.025quant`),
  lmed95 = exp(delta_i$`0.5quant`),
  lsup95 = exp(delta_i$`0.975quant`)
)

d_giswgs <- d_giswgs %>%
  mutate(idarea = row_number()) %>%
  left_join(df_deltai, by = "idarea")

# Paleta de cores
pal <- colorNumeric(
  palette = colorRampPalette(c("#2166AC", "white", "#B2182B"))(100),
  domain = d_gis$lmed95,
  na.color = "transparent"
)

# Criar mapa interativo
leaflet(d_giswgs, width = 600, height = 450) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal(lmed95),
    fillOpacity = 0.7,
    color = "grey80",
    weight = 1,
    popup = ~paste0(
      "<b>Concelho:</b> ", nome_cc, "<br>",
      "<b>RR:</b> ", round(lmed95, 3), "<br>",
      "<b>IC 95%:</b> [", round(linf95, 3), " - ", round(lsup95, 3), "]"
    ),
    label = ~nome_cc,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = ~lmed95,
    title = "RR <br>Modelo M2",
    opacity = 0.7
  )


```


Os concelhos com um aumento mais acentuado, estão maioritariamente concentrados na região da grande Lisboa. Para identificar concelhos com tendências temporais significativas, obtiveram-se intervalos de credibilidade a 95% para $\exp(\delta_i)$. Esta quantidade representa o fator de variação anual do RR de mortalidade infantil, ou seja, a razão dos RRs entre anos consecutivos.

#### Modelo M6 {#sec-ResultadosM6}

O modelo M6 inclui o efeito espacial dado pela componentes espacial estruturada $u_i$ e não-estruturada $v_i$, o efeito temporal dado pela componente estruturada $\gamma_j$ (definida por um passeio aleatório de primeira ordem conforme apresentado na @sec-MetodosModelosBayes), e não-estruturada $\phi_j$ com distribuição $\text{N}\sim (0,\sigma_\phi^2)$, e o efeito da covariável EDI.

$$\log(\theta_{ij})=\alpha+u_i+v_i+\gamma_j + \phi_j + \beta_{\scriptsize\text{EDI}} \times \scriptsize\text{EDI}_i$$

Neste modelo, a linearidade imposta no modelo anterior (M2) a $\delta_i$ é abandonada para dar lugar ao termo $\gamma_j$, que tem uma formulação não-paramétrica, modelada dinâmicamente.

```{r tempoplot,  fig.align='center', out.width="70%"}

# codigo e plot pagina 240- SPATIAL AND SPATIO-TEMPORAL BAYESIAN MODELS WITH R-INLA

temporal.CAR <- lapply(m6_res$marginals.random$idtime, 
                       function(X){marg <- inla.tmarginal(function(x) exp(x), X)
                       inla.emarginal(mean, marg)
})

temporal.IID <- lapply(m6_res$marginals.random$idtime1, 
                       function(X){
                         marg <- inla.tmarginal(function(x) exp(x), X)
                         inla.emarginal(mean, marg)
})


# Converter para vetores
temporal.CAR <- unlist(temporal.CAR)
temporal.IID <- unlist(temporal.IID)
Anos <- 2015:2024

df <- data.frame(
  year = Anos,
  gamj = temporal.CAR,
  phij = temporal.IID
)

df_long <- pivot_longer(df, cols = c("gamj", "phij"),
                        names_to = "effect", values_to = "value")

ggplot(df_long, aes(x = year, y = value, linetype = effect)) +
  geom_line(linewidth = 0.8) +
  scale_linetype_manual(values = c("gamj" = "dotted", 
                                   "phij" = "solid"),
                        # labels = c("Estruturado (γ)", "Unstructured (φ)")) +
                        labels = c(expression(exp(gamma[j])), expression(exp(phi[j])))) +
  labs(x = "Ano", y = "exp(efeito temporal)") +
  theme_minimal() +
  theme(legend.title = element_blank())

```

Até 2021 uma tendência decrescente é visivel no efeito estruturado, enquanto que o termo associado à componente não estruturada apresenta flutuações em torno de 1.

O padrão espaço-temporal das médias das distribuições à posteriori dos RRs apresenta-se na figura seguinte: 

```{r mapas-rr, fig.align='center', out.width="100%"}

library(leafsync)

d$RR6 <- m6_res$summary.fitted.values[, "mean"]
d$LL6 <- m6_res$summary.fitted.values[, "0.025quant"]
d$UL6 <- m6_res$summary.fitted.values[, "0.975quant"]

# plot
mapa_in <- merge(
  mapa, d,
  by.x = c("nome_cc", "ano"),
  by.y = c("cc", "ano")
)
ggplot(mapa_in) + geom_sf(aes(fill = RR6)) +
  facet_wrap(~ano, dir = "h", ncol = 5) +
  ggtitle("RR (M6)") + theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  ) +
  scale_fill_gradient2(
    midpoint = 1, low = "blue", mid = "white", high = "red"
  )
# ggsave("rr6.png")
```


Em termo globais, os resultados obtidos até 2021 estão alinhados com os publicados para o periodo 2016-2021 por Nogueira et al^[https://doi.org/10.20344/amp.19642], que evidência o progresso notável na redução da TMI atingindo os valores mais baixos de sempre durante a pandemia da COVID-19. No entanto, a partir de 2021 observa-se um aumento generalizado do RR, ainda que com valores inferiores aos registados em 2015-2019.

A tabela seguinte contém as estimativas dos RR com IC95% por concelho/ano. Os concelhos/anos com RR significativamente superiores (a 1) estão pintados a rosa.

```{r, fig.align='center', out.width="50%"}

rr6_wide <- d %>%
  dplyr::select(cc, ano, RR6) %>%
  pivot_wider(
    names_from = ano,
    values_from = RR6
  )

# LL1
rr6LL_wide <- d %>%
  dplyr::select(cc, ano, LL6) %>%
  pivot_wider(
    names_from = ano,
    values_from = LL6
  )

# UL6
rr6UL_wide <- d %>%
  dplyr::select(cc, ano, UL6) %>%
  pivot_wider(
    names_from = ano,
    values_from = UL6
  )

rr_table <- tabrr_val(rr6_wide, rr6LL_wide , rr6UL_wide , digits = 2)
tabrr(rr_table)
```

```{r fixed-edi, fig.align='center', out.width="50%"}
marginal <- inla.smarginal(m6_res$marginals.fixed$EDI_SCORE)
marginal <- data.frame(marginal)

ediplot <- ggplot(marginal, aes(x = x, y = y)) + geom_line() +
  labs(x = expression(beta[1]), y = "Density") +
   geom_vline(xintercept = 0, col = "black", lty = 2) + 
  ylab("EDI")


# Convert marginal to data frame
marginal <- m6_res$marginals.fixed$EDI_SCORE
df <- data.frame(x = marginal[,1], y = marginal[,2])

# Get summary statistics
summary_stats <- m6_res$summary.fixed["EDI_SCORE", ]

```

Em relação à covariável EDI, os resultados do modelo M6 indicam que, após controlar o efeito da estrutura espacial e temporal, o aumento de uma unidade no índice de privação sugere um aumento significativo no RR de mortalidade infantil `r round((exp(m6_res$summary.fixed["EDI_SCORE","mean"])-1) * 100,2)`% (IC 95%:`r round((exp(m6_res$summary.fixed["EDI_SCORE",c("0.025quant", "0.975quant")])-1) *100,1)`%), face ao risco médio da população.

```{r fixed-ediplot, out.width="50%", fig.align='center'}

ggplot(df, aes(x = x, y = y)) +
  geom_line(size = 1.2, color = "black") +
  # geom_area(alpha = 0.3, fill = "lightblue") +
  geom_vline(xintercept = summary_stats$mean, 
             color = "black", linetype = "dashed", size = 1) +
  geom_vline(xintercept = summary_stats$`0.025quant`, 
             color = "darkgray", linetype = "dotted") +
  geom_vline(xintercept = summary_stats$`0.975quant`, 
             color = "darkgray", linetype = "dotted") +
  labs(title = "Distribuição à posteriori",
       x = expression(beta[EDI]), 
       y = "Densidade") +
  theme_minimal()
#  
# marginal <- m6_res$marginals.fixed$EDI_SCORE
# inla.pmarginal(c(-Inf, Inf), marginal) 

```

#### Modelo M6 (2024) {#sec-ResultadosM62024} 

Nesta secção apresentam-se os resultados para o ano 2024 com mais detalhe. Em particular apresenta-se um gráfico de barras com as estimativas dos RRs em cada concelho e o respectivo IC95%. As barras dos concelhos com RR significativamente superiores a 1 estão pintadas a vermelho: Amadora, Barreiro e Odemira.

```{r barplot, eval=T,fig.align='center', out.width="75%"}

# Load required libraries
library(ggrepel)

d_sort <- d %>%
  group_by(ano) %>%
  arrange(ano, RR6) %>%
  mutate(cc_rank = row_number()) %>%
  ungroup()

# # plot todos os anos (le-se mal)
# p <- ggplot(d_sort, aes(x = cc_rank, y = RR6)) +
#   geom_errorbar(aes(ymin = LL6, ymax = UL6,
#                     color = ifelse(LL1 >= 1, "Significant", "Not Significant")), 
#                 width = 0.4, 
#                 alpha = 0.7) +
#   geom_point(aes(color = ifelse(LL1 >= 1, "Significant", "Not Significant")), size = 1.5) +
#   geom_text_repel(data = subset(d_sort, LL1 >= 1),
#                     aes(label = cc), 
#                     size = 2.5,
#                     color = "black",
#                     box.padding = 0.3,
#                     point.padding = 0.2,
#                     force = 2,
#                     max.overlaps = Inf,
#                     segment.color = "grey90",
#                     segment.size = 0.3) +
#   geom_hline(yintercept = 1, colour = "grey50", linetype = 2) +
#   scale_color_manual(values = c("Not Significant" = "grey90", 
#                                "Significant" = "red")) +
#   facet_wrap(~ ano, nrow = 2, scales = "free_x", shrink = F ) +
#   theme_minimal() +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     plot.subtitle = element_text(hjust = 0.5),
#     strip.text = element_text(face = "bold"),
#     axis.text.x = element_blank(),
#     legend.position = "none"
#   ) +
#   xlab(NULL)
# 
# print(p)

# ano 2024
p2 <- ggplot(d_sort[which(d_sort$ano==2024),], aes(x = cc_rank, y = RR6)) +
  geom_errorbar(aes(ymin = LL6, ymax = UL6,
                    color = ifelse(LL6 >= 1, "*", "n.s.")), 
                width = 0.4, 
                alpha = 0.7) +
  geom_point(aes(color = ifelse(LL6 >= 1, "*", "n.s.")), size = 1.5) +
  geom_text_repel(data = subset(d_sort[which(d_sort$ano==2024),], LL6 >= 1),
                    aes(label = cc), 
                    size = 2.5,
                    color = "black",
                    box.padding = 0.3,
                    point.padding = 0.2,
                    force = 2,
                    max.overlaps = Inf,
                    segment.color = "grey60",
                    segment.size = 0.3) +
  geom_hline(yintercept = 1, colour = "grey50", linetype = 2) +
  scale_color_manual(values = c("n.s." = "grey60", 
                               "*" = "red")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    strip.text = element_text(face = "bold"),
    axis.text.x = element_blank(),
    legend.position = "none"
  ) +
  xlab(NULL)
p2
```

## Conclusões

Os modelos M6 e M7 forneceram estimativas suavizadas dos efeitos não lineares espaciais (BYM2) e temporais (RW1) no mapeamento do risco relativo de mortalidade infantil, permitindo identificar tendências particularmente importantes, nomeadamente na identificação de concelhos com riscos significativamente elevados (p.e. Amadora, Barreiro e Odemira em 2024). Usou-se uma abordagem Bayesiana com INLA para ultrapassar as limitações computacionais dos métodos tradicionais. Esta abordagem permitiu obter distribuições marginais a posteriori de forma rápida e precisa.

A inclusão da variável de efeito de interação (EDI) melhorou significativamente o ajuste dos modelos M5-M7 em comparação com os modelos M2-M4, demonstrando que, controlando os efeitos espaciais e temporais, um aumento de uma unidade no índice de privação está associado a um aumento de 3,7% (IC95%: 1,4%-5,9%) no risco relativo de mortalidade infantil (conforme resultado observado no modelo M6). 

A comparação entre modelos revelou que os modelos M6 e M7 apresentam os melhores ajustamentos, mas que a inclusão da interação espaço-temporal (M7) não proporcionou melhorias substanciais em relação ao modelo M6, sugerindo que a interação não é significativa na variação do risco. Estudos adicionais são necessários para avaliar se esta conclusão se mantém em análises com períodos temporais mais longos ou contextos com maior heterogeneidade espaço-temporal.
